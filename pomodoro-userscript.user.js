// ==UserScript==
// @name        pomodoro-userscript
// @version     0.0.1
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://greasify.github.io/pomodoro-userscript/
// @match       http://localhost:3000
// @match       *
// @grant       GM_addStyle
// @updateURL   https://greasify.github.io/pomodoro-userscript/pomodoro-userscript.meta.js
// @downloadURL https://greasify.github.io/pomodoro-userscript/pomodoro-userscript.user.js
// ==/UserScript==

(function(){"use strict";const P=r=>(e,t)=>(r.set(e,t),t),N=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,S=536870912,O=S*2,F=(r,e)=>t=>{const n=e.get(t);let s=n===void 0?t.size:n<O?n+1:0;if(!t.has(s))return r(t,s);if(t.size<S){for(;t.has(s);)s=Math.floor(Math.random()*O);return r(t,s)}if(t.size>N)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;t.has(s);)s=Math.floor(Math.random()*N);return r(t,s)},C=new WeakMap,U=P(C),L=F(U,C),q=r=>typeof r.start=="function",R=new WeakMap,j=r=>({...r,connect:({call:e})=>async()=>{const{port1:t,port2:n}=new MessageChannel,s=await e("connect",{port:t},[t]);return R.set(n,s),n},disconnect:({call:e})=>async t=>{const n=R.get(t);if(n===void 0)throw new Error("The given port is not connected.");await e("disconnect",{portId:n})},isSupported:({call:e})=>()=>e("isSupported")}),_=new WeakMap,B=r=>{if(_.has(r))return _.get(r);const e=new Map;return _.set(r,e),e},V=r=>{const e=j(r);return t=>{const n=B(t);t.addEventListener("message",(({data:d})=>{const{id:u}=d;if(u!==null&&n.has(u)){const{reject:m,resolve:c}=n.get(u);n.delete(u),d.error===void 0?c(d.result):m(new Error(d.error.message))}})),q(t)&&t.start();const s=(d,u=null,m=[])=>new Promise((c,l)=>{const a=L(n);n.set(a,{reject:l,resolve:c}),u===null?t.postMessage({id:a,method:d},m):t.postMessage({id:a,method:d,params:u},m)}),i=(d,u,m=[])=>{t.postMessage({id:null,method:d,params:u},m)};let h={};for(const[d,u]of Object.entries(e))h={...h,[d]:u({call:s,notify:i})};return{...h}}},E=new Map([[0,null]]),M=new Map([[0,null]]),W=V({clearInterval:({call:r})=>e=>{typeof E.get(e)=="symbol"&&(E.set(e,null),r("clear",{timerId:e,timerType:"interval"}).then(()=>{E.delete(e)}))},clearTimeout:({call:r})=>e=>{typeof M.get(e)=="symbol"&&(M.set(e,null),r("clear",{timerId:e,timerType:"timeout"}).then(()=>{M.delete(e)}))},setInterval:({call:r})=>(e,t=0,...n)=>{const s=Symbol(),i=L(E);E.set(i,s);const h=()=>r("set",{delay:t,now:performance.timeOrigin+performance.now(),timerId:i,timerType:"interval"}).then(()=>{const d=E.get(i);if(d===void 0)throw new Error("The timer is in an undefined state.");d===s&&(e(...n),E.get(i)===s&&h())});return h(),i},setTimeout:({call:r})=>(e,t=0,...n)=>{const s=Symbol(),i=L(M);return M.set(i,s),r("set",{delay:t,now:performance.timeOrigin+performance.now(),timerId:i,timerType:"timeout"}).then(()=>{const h=M.get(i);if(h===void 0)throw new Error("The timer is in an undefined state.");h===s&&(M.delete(i),e(...n))}),i}}),D=((r,e)=>{let t=null;return()=>{if(t!==null)return t;const n=new Blob([e],{type:"application/javascript; charset=utf-8"}),s=URL.createObjectURL(n);return t=r(s),setTimeout(()=>URL.revokeObjectURL(s)),t}})(r=>{const e=new Worker(r);return W(e)},`(()=>{var e={455:function(e,t){!function(e){"use strict";var t=function(e){return function(t){var r=e(t);return t.add(r),r}},r=function(e){return function(t,r){return e.set(t,r),r}},n=void 0===Number.MAX_SAFE_INTEGER?9007199254740991:Number.MAX_SAFE_INTEGER,o=536870912,s=2*o,a=function(e,t){return function(r){var a=t.get(r),i=void 0===a?r.size:a<s?a+1:0;if(!r.has(i))return e(r,i);if(r.size<o){for(;r.has(i);)i=Math.floor(Math.random()*s);return e(r,i)}if(r.size>n)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;r.has(i);)i=Math.floor(Math.random()*n);return e(r,i)}},i=new WeakMap,u=r(i),c=a(u,i),l=t(c);e.addUniqueNumber=l,e.generateUniqueNumber=c}(t)}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,r),s.exports}(()=>{"use strict";const e=-32603,t=-32602,n=-32601,o=(e,t)=>Object.assign(new Error(e),{status:t}),s=t=>o('The handler of the method called "'.concat(t,'" returned an unexpected result.'),e),a=(t,r)=>async({data:{id:a,method:i,params:u}})=>{const c=r[i];try{if(void 0===c)throw(e=>o('The requested method called "'.concat(e,'" is not supported.'),n))(i);const r=void 0===u?c():c(u);if(void 0===r)throw(t=>o('The handler of the method called "'.concat(t,'" returned no required result.'),e))(i);const l=r instanceof Promise?await r:r;if(null===a){if(void 0!==l.result)throw s(i)}else{if(void 0===l.result)throw s(i);const{result:e,transferables:r=[]}=l;t.postMessage({id:a,result:e},r)}}catch(e){const{message:r,status:n=-32603}=e;t.postMessage({error:{code:n,message:r},id:a})}};var i=r(455);const u=new Map,c=(e,r,n)=>({...r,connect:({port:t})=>{t.start();const n=e(t,r),o=(0,i.generateUniqueNumber)(u);return u.set(o,()=>{n(),t.close(),u.delete(o)}),{result:o}},disconnect:({portId:e})=>{const r=u.get(e);if(void 0===r)throw(e=>o('The specified parameter called "portId" with the given value "'.concat(e,'" does not identify a port connected to this worker.'),t))(e);return r(),{result:null}},isSupported:async()=>{if(await new Promise(e=>{const t=new ArrayBuffer(0),{port1:r,port2:n}=new MessageChannel;r.onmessage=({data:t})=>e(null!==t),n.postMessage(t,[t])})){const e=n();return{result:e instanceof Promise?await e:e}}return{result:!1}}}),l=(e,t,r=()=>!0)=>{const n=c(l,t,r),o=a(e,n);return e.addEventListener("message",o),()=>e.removeEventListener("message",o)},d=(e,t)=>r=>{const n=t.get(r);if(void 0===n)return Promise.resolve(!1);const[o,s]=n;return e(o),t.delete(r),s(!1),Promise.resolve(!0)},f=(e,t,r,n)=>(o,s,a)=>{const i=o+s-t.timeOrigin,u=i-t.now();return new Promise(t=>{e.set(a,[r(n,u,i,e,t,a),t])})},m=new Map,h=d(globalThis.clearTimeout,m),p=new Map,v=d(globalThis.clearTimeout,p),w=((e,t)=>{const r=(n,o,s,a)=>{const i=n-e.now();i>0?o.set(a,[t(r,i,n,o,s,a),s]):(o.delete(a),s(!0))};return r})(performance,globalThis.setTimeout),g=f(m,performance,globalThis.setTimeout,w),T=f(p,performance,globalThis.setTimeout,w);l(self,{clear:async({timerId:e,timerType:t})=>({result:await("interval"===t?h(e):v(e))}),set:async({delay:e,now:t,timerId:r,timerType:n})=>({result:await("interval"===n?g:T)(e,t,r)})})})()})();`),G=r=>D().clearInterval(r),z=(...r)=>D().setInterval(...r);class X{#e={};on(e,t){const n=this.listeners(e);return n.push(t),this.#e[e]=n,this}once(e,t){const n=new Proxy(t,{apply:(s,i,h)=>{s(...h),this.off(e,n)}});return this.on(e,n),n}emit(e,...t){const n=this.listeners(e);for(let s=0;s<n.length;s++)n[s](...t);return!!n.length}off(e,t){return this.#e[e]&&(this.#e[e]=this.#e[e].filter(n=>n!==t)),this}removeAllListeners(e){return e?delete this.#e[e]:this.#e={},this}eventNames(){return Reflect.ownKeys(this.#e)}listeners(e){return this.#e[e]??[]}listenerCount(e){return this.#e[e]?.length??0}}const w=new X;class K{interval;minutes;seconds;setTime({minutes:e,seconds:t}){this.minutes=e,this.seconds=t}start(){this.stop(),this.interval=z(()=>this.tick(),1e3)}stop(){this.interval&&(G(this.interval),this.interval=null)}tick(){this.seconds--,this.minutes>0&&this.seconds<0&&(this.seconds=59,this.minutes--),this.minutes===0&&this.seconds===0&&w.emit("timer_stop"),w.emit("timer_tick",{minutes:this.minutes,seconds:this.seconds})}}function T(r,e,...t){const n=document.createElement(r);return e instanceof Node?n.append(e):typeof e=="string"?n.append(Y(e)):Array.isArray(e)?n.append(...e):(Object.assign(n,e),Object.assign(n.style,e?.style)),n.append(...t),n}function Y(r){return document.createTextNode(r)}function H(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var x={exports:{}};var $=x.exports,A;function J(){return A||(A=1,(function(r,e){(function(t,n){r.exports=n()})($,function(){return(function(t){function n(i){if(s[i])return s[i].exports;var h=s[i]={exports:{},id:i,loaded:!1};return t[i].call(h.exports,h,h.exports,n),h.loaded=!0,h.exports}var s={};return n.m=t,n.c=s,n.p="",n(0)})([function(t,n,s){function i(u){return u&&u.__esModule?u:{default:u}}var h=s(1),d=i(h);t.exports=d.default},function(t,n,s){function i(a,o){if(!(a instanceof o))throw new TypeError("Cannot call a class as a function")}function h(){var a=this,o=this.el,p=this.opts||c,g={};if(o.style.position="absolute",this.handle=p.handle||o,p.constrain){for(var v=p.relativeTo||o.parentNode,f=o,b=0,I=0;f!==v;)f=f.parentNode,(0,d.isRelative)(f)&&(b-=f.offsetLeft,I-=f.offsetTop),f===v&&(b+=f.offsetLeft,I+=f.offsetTop);var ce=b+v.offsetWidth-o.offsetWidth,le=I+v.offsetHeight-o.offsetHeight;g.xClamp=(0,d.generateClamp)(b,ce),g.yClamp=(0,d.generateClamp)(I,le)}this.opts=p,this.data=g,this.events={mousedown:u.mousedown.bind(this),mouseup:u.mouseup.bind(this),touchstart:u.touchstart.bind(this),touchstop:u.touchstop.bind(this),scrollFix:function(he){a.isDragging&&he.preventDefault()}},this.handleMove=m(this.opts.customMove),this.handle.addEventListener("mousedown",this.events.mousedown,!1),this.handle.addEventListener("touchstart",this.events.touchstart,!1),document.addEventListener("touchmove",this.events.scrollFix,{passive:!1})}Object.defineProperty(n,"__esModule",{value:!0});var d=s(2),u=s(3),m=(0,d.generateMoveFn)(),c={constrain:!1,relativeTo:null,handle:null,ignoreFn:null,highlightInputs:!1,onMouseDown:null,onMouseMove:null,onMouseUp:null,onTouchStart:null,onTouchMove:null,onTouchStop:null,customMove:null},l=(function(){function a(o,p){if(i(this,a),!o)throw Error("Must include moveable element");this.el=o,this.opts=p,h.call(this)}return a.prototype.reinit=function(){this.destroy(),h.call(this)},a.prototype.destroy=function(){var o=this.events;this.handle.removeEventListener("mousedown",o.mousedown,!1),document.removeEventListener("mousemove",o.mousemove,!1),document.removeEventListener("mouseup",o.mouseup,!1),this.handle.removeEventListener("touchstart",o.touchstart,!1),document.removeEventListener("touchmove",o.touchmove,!1),document.removeEventListener("touchstop",o.touchstop,!1),document.removeEventListener("touchmove",this.events.scrollFix,{passive:!1})},a})();n.default=function(a,o){return new l(a,o)}},function(t,n){function s(u,m){return function(c){return Math.min(Math.max(c,u),m)}}function i(u){return window.getComputedStyle(u).position==="relative"}function h(){return window.requestAnimationFrame?function(u){var m=u||d;return function(c,l,a){window.requestAnimationFrame(function(){m(c,l,a)})}}:function(u){return function(m,c,l){var a=u||d;a(m,c,l)}}}function d(u,m,c){u.style.left=m+"px",u.style.top=c+"px"}Object.defineProperty(n,"__esModule",{value:!0}),n.generateClamp=s,n.isRelative=i,n.generateMoveFn=h},function(t,n){function s(c){var l=this.opts;if(l.highlightInputs){var a=c.target.tagName.toLowerCase();if(a==="input"||a==="textarea")return}if(!l.ignoreFn||!l.ignoreFn(c)){if(c.button===0){var o=this.el,p=this.events;typeof l.onMouseDown=="function"&&l.onMouseDown(o,c);var g=c.clientX-o.offsetLeft,v=c.clientY-o.offsetTop;p.mousemove=i.bind(this,g,v),document.addEventListener("mousemove",p.mousemove,!1),document.addEventListener("mouseup",p.mouseup,!1)}c.preventDefault()}}function i(c,l,a){var o=this.el,p=this.opts,g=this.data;typeof p.onMouseMove=="function"&&p.onMouseMove(o,a);var v=a.clientX-c,f=a.clientY-l;return p.constrain&&(v=g.xClamp(v),f=g.yClamp(f)),this.handleMove(o,v,f),a.preventDefault(),!1}function h(c){var l=this.el,a=this.opts,o=this.events;typeof a.onMouseUp=="function"&&a.onMouseUp(l,c),document.removeEventListener("mouseup",o.mouseup,!1),document.removeEventListener("mousemove",o.mousemove,!1)}function d(c){var l=this.opts;if(l.highlightInputs){var a=c.target.tagName.toLowerCase();if(a==="input"||a==="textarea")return}if(!l.ignoreFn||!l.ignoreFn(c)){var o=this.el,p=this.events;typeof l.onTouchStart=="function"&&l.onTouchStart(o,c);var g=c.targetTouches[0],v=g.clientX-o.offsetLeft,f=g.clientY-o.offsetTop;p.touchmove=u.bind(this,v,f),this.isDragging=!0,document.addEventListener("touchmove",p.touchmove,!1),document.addEventListener("touchend",p.touchstop,!1),document.addEventListener("touchcancel",p.touchstop,!1)}}function u(c,l,a){var o=this.el,p=this.opts,g=this.data;typeof p.onTouchMove=="function"&&p.onTouchMove(o,a);var v=a.targetTouches[0],f=v.clientX-c,b=v.clientY-l;return p.constrain&&(f=g.xClamp(f),b=g.yClamp(b)),this.handleMove(o,f,b),a.preventDefault(),!1}function m(c){this.isDragging=!1;var l=this.el,a=this.opts,o=this.events;typeof a.onTouchStop=="function"&&a.onTouchStop(l,c),document.removeEventListener("touchmove",o.touchmove,!1),document.removeEventListener("touchend",o.touchstop,!1),document.removeEventListener("touchcancel",o.touchstop,!1)}Object.defineProperty(n,"__esModule",{value:!0}),n.mousedown=s,n.mousemove=i,n.mouseup=h,n.touchstart=d,n.touchmove=u,n.touchstop=m}])})})(x)),x.exports}var Q=J();const Z=H(Q);class ee{target;displace;options;constructor(...e){this.target=this.options?.handle??e[0],this.options=e[1],this.displace=Z(...e),this.destroy(),this.reinit=this.reinit.bind(this);const t=()=>{this.displace.reinit(),this.target.removeEventListener("mouseenter",t)};this.target.addEventListener("mouseenter",t),window.addEventListener("resize",this.reinit)}reinit(){this.displace.reinit()}destroy(){this.displace.destroy(),window.removeEventListener("resize",this.reinit)}changePosition(e,t){this.target.style.left=`${e}px`,this.target.style.top=`${t}px`}}class te{#e;#t;#s;#r;#n;constructor(e,t,n,s){this.#e=e,this.#t=t,this.#n=n,this.#s=i=>s?.encode?s.encode(i):JSON.stringify(i),this.#r=i=>s?.decode?s.decode(i):JSON.parse(i),this.has()||this.write(this.#t)}get initialValue(){return this.#t}get value(){try{const e=this.#n.getItem(this.#e);return e?this.#r(e):this.#t}catch(e){return console.error(e),this.#t}}write(e){e instanceof Function&&(e=e(this.value));try{this.#n.setItem(this.#e,this.#s(e))}catch(t){return console.error(t),this.#t}return e}has(){return this.#n.getItem(this.#e)!==null}reset(){this.write(this.#t)}}class ne extends te{constructor(e,t,n){super(e,t,localStorage,n)}}class se{initialData={time:{minutes:0,seconds:0},onTickTime:{minutes:0,seconds:0},isRunning:!1,position:{x:0,y:0}};storage=new ne("pomodoro-storage",this.initialData);get data(){return this.storage.value}getByKey(e){return this.data[e]}write(e){this.storage.write(e)}reset(){this.storage.reset()}}const y=new se;class re{el;interact;mount(e){this.el=T("div",{className:"overlay"},e),this.interact=new ee(e,{constrain:!0,relativeTo:this.el,handle:e,onMouseDown:()=>{this.el.classList.add("grabbing")},onMouseUp:()=>{this.el.classList.remove("grabbing")},onMouseMove:t=>{const{x:n,y:s}=t.getBoundingClientRect();y.write(i=>({...i,position:{x:n,y:s}}))}}),this.updatePosition(),document.body.appendChild(this.el)}updatePosition(){const{x:e,y:t}=y.getByKey("position");this.interact.changePosition(e,t)}}function k(r){return r<10?`0${r}`:`${r}`}const oe=["minutes","seconds"];class ie{el;seconds;minutes;inputClock=0;currentInput;get inputData(){return{type:this.currentInput.dataset.type,time:this.currentInput.textContent}}mount(){for(const e of oe){const t=T("div",{contentEditable:"true"});t.dataset.type=e,t.addEventListener("keydown",n=>this.onKeyDown(n)),t.addEventListener("click",n=>{n.preventDefault(),this.focusInput(t)}),this[e]=t}this.updateInputValues(),this.el=T("div",{className:"timer"},this.minutes,":",this.seconds)}focusInput(e){this.currentInput=e,this.currentInput.focus(),this.updateInputClock(0)}onKeyDown(e){switch(e.preventDefault(),e.key){case"Enter":case"Escape":w.emit("timer_start",y.getByKey("time")),this.currentInput.blur();break;case"ArrowLeft":case"ArrowRight":this.navigateInput();break;case"ArrowUp":case"ArrowDown":this.incrementInputValue(e.key==="ArrowUp"?1:-1);break;default:if(Number.isNaN(parseInt(e.key)))return;this.changeInputValue(e.key)}}navigateInput(){const e=this.currentInput.nextElementSibling??this.currentInput.previousElementSibling;this.focusInput(e)}changeInputValue(e){const{type:t,time:n}=this.inputData,s=this.inputClock?n.slice(1)+e:n.slice(0,1)+e,i=this.parseTime(t,s);this.writeInputValues(t,i),this.updateInputClock()}incrementInputValue(e){const{type:t,time:n}=this.inputData,s=this.parseTime(t,n,e);this.writeInputValues(t,s)}writeInputValues(e,t){this[e].textContent=k(t),y.write(n=>({...n,time:{...n.time,[e]:t}}))}updateInputClock(e){this.inputClock=e??(this.inputClock+1)%2}parseTime(e,t,n=0){let s=parseInt(t)+n;switch(e){case"minutes":s<0&&(s=99),s>99&&(s=0);break;case"seconds":s<0&&(s=59),s>59&&(s=0);break}return s}updateInputValues(e){const t=y.getByKey("time");this.minutes.textContent=k(e?e.minutes:t.minutes),this.seconds.textContent=k(e?e.seconds:t.seconds),e&&y.write(n=>({...n,onTickTime:e}))}}class ae{el;container;draggable;timer;mount(e,t){this.timer=t,this.draggable=e,this.container=T("div",{className:"widget-container"},this.timer.el),this.el=T("div",{className:"widget",onmouseenter:()=>{this.draggable.el.classList.add("moved")},onmouseleave:()=>{this.draggable.el.classList.remove("moved")},onauxclick:n=>{n.preventDefault()},oncontextmenu:n=>{n.preventDefault()}},this.container)}}GM_addStyle(`.overlay {
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  cursor: grab;

  &.moved {
    position: fixed;
  }

  &.grabbing {
    cursor: grabbing;
  }

  .widget {
    z-index: 999999;
    position: fixed !important;
    background-color: #1f1f23;
    width: 70px;
    height: 32px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5), 0 0 4px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .widget-container {
    font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande',
      'Lucida Sans', Arial, sans-serif;
    font-size: 24px;
    color: #fff;
  }
}

.timer {
  display: flex;
  flex-direction: row;

  div {
    display: block;
    text-align: center;
    caret-color: transparent;

    &:focus {
      outline: none;
      color: tomato;
    }
  }
}
`);class ue{timer;draggable;widget;countdown;constructor(){this.timer=new ie,this.draggable=new re,this.widget=new ae,this.countdown=new K}mount(){this.timer.mount(),this.widget.mount(this.draggable,this.timer),this.draggable.mount(this.widget.el),w.on("timer_start",e=>{this.countdown.setTime(e),this.countdown.start(),y.write(t=>({...t,isRunning:!0}))}),w.on("timer_stop",()=>{this.countdown.stop(),y.write(e=>({...e,isRunning:!0}))}),w.on("timer_tick",e=>{this.timer.updateInputValues(e)}),window.addEventListener("storage",e=>{const t=JSON.parse(e.oldValue),n=JSON.parse(e.newValue);!t.isRunning&&n.isRunning&&w.emit("timer_start",n.time),t.isRunning&&!n.isRunning&&w.emit("timer_stop"),e.key==="pomodoro-store"&&(this.draggable.updatePosition(),this.timer.updateInputValues())})}}new ue().mount()})();
